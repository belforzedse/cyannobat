# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Next.js 15 application integrated with PayloadCMS 3.x, using PostgreSQL as the database and Redis for caching. The project combines a headless CMS backend with a Next.js frontend in a monolithic architecture. It includes a glassmorphic UI with Persian language support (RTL) and light/dark theme capabilities.

## Development Commands

```bash
# Start development server (default port 3000)
npm run dev

# Build production bundle
npm run build

# Start production server
npm run start

# Run ESLint
npm run lint

# Type checking
npm run typecheck
```

## Docker Environment

The project includes Docker Compose configuration with three services:

- `postgres`: PostgreSQL 16 database (port 5432)
- `redis`: Redis 7 cache (port 6379)
- `web`: Next.js application (port 3000)

Start services:

```bash
docker-compose up -d
```

CI pipeline (GitHub Actions) runs: `pnpm lint` → `pnpm typecheck` → `pnpm build`

## Architecture

### Route Group Structure

The application uses Next.js App Router with three distinct route groups:

1. **`(payload)` Route Group** - PayloadCMS Admin & API
   - Admin panel at `/admin` (auto-generated by Payload)
   - REST API at `/api/[...slug]`
   - GraphQL API at `/api/graphql` and `/api/graphql-playground`
   - Uses custom layout with Payload's RootLayout component
   - Files marked "GENERATED AUTOMATICALLY BY PAYLOAD" should not be manually modified

2. **`(frontend)` Route Group** - Main Application Frontend
   - Default landing page that integrates with Payload auth
   - Shows welcome message and links to admin panel
   - Located at `src/app/(frontend)/page.tsx`

3. **`(site)` Route Group** - Main Booking Frontend
   - Primary user-facing application with booking functionality
   - Uses glassmorphic design system with Peyda font
   - Fixed right sidebar (GNOME-style), top header navigation
   - Located at `src/app/(site)/`
   - Layout: `src/app/(site)/layout.tsx` (Header + Sidebar + Content)

### PayloadCMS Configuration

Main config: `src/payload.config.ts`

Key aspects:

- Database: PostgreSQL via `@payloadcms/db-postgres`
- Rich text editor: Lexical (`@payloadcms/richtext-lexical`)
- Image processing: Sharp
- Collections are defined in `src/collections/`
- TypeScript types auto-generated to `src/payload-types.ts`

### Collections

Defined in `src/collections/`:

- **Users**: Authentication collection with email as title field
- **Media**: File upload collection with public read access and required alt text
- **Providers**: Service providers with relationship to user accounts
- **Services**: Bookable services with pricing, duration, and provider relationships
- **Appointments**: Booking records with complex scheduling logic and access control

To add new collections:

1. Create collection config in `src/collections/`
2. Import and add to `collections` array in `src/payload.config.ts`
3. Types will regenerate automatically

### Environment Variables

Required in `.env`:

- `PAYLOAD_SECRET`: Secret key for Payload authentication
- `DATABASE_URI`: PostgreSQL connection string (format: `postgresql://user:pass@host:port/db`)
- `REDIS_URL`: Redis connection URL (currently stubbed in-memory)
- `REDIS_TLS`: Set to "true" for TLS-enabled Redis instances
- `PAYLOAD_DB_PUSH`: Set to "true" to auto-push schema changes (dev only)
- `PAYLOAD_RUN_MIGRATIONS`: Set to "true" to run migrations on startup
- `NEXT_PUBLIC_APP_URL`: Public URL for client-side code

Docker defaults:

- DB: `postgresql://cyannobat:cyannopass@postgres:5432/cyannobat`
- Redis: `redis://localhost:6379`

### Database Migrations

In development (`NODE_ENV=development`), Payload automatically pushes schema changes to PostgreSQL on startup when `PAYLOAD_DB_PUSH=true`.

For production deployments, generate tracked migrations:

```bash
pnpm payload migrate:create -- --name <migration-name>
pnpm payload migrate
```

Migration files are stored in `src/payload-migrations/` and should be committed to version control.

### TypeScript Configuration

Path aliases:

- `@/*` maps to `src/*`
- `@styles/*` maps to `styles/*`
- `@payload-config` maps to `src/payload.config.ts`

Target: ES2017 with strict mode enabled

### Next.js Configuration

The Next.js config (`next.config.ts`) wraps the base configuration with `withPayload()` from `@payloadcms/next/withPayload` - this is required for Payload integration.

## Key Integration Points

### Accessing Payload in Server Components

```typescript
import { getPayload } from 'payload';
import config from '@payload-config';

const payload = await getPayload({ config });
```

### Checking Authentication

```typescript
import { headers as getHeaders } from 'next/headers';
const headers = await getHeaders();
const { user } = await payload.auth({ headers });
```

### Direct Database Access with Drizzle

The project exports `payloadDrizzle` and `payloadDbPool` from `src/payload.config.ts` for direct SQL queries when Payload's ORM is insufficient:

```typescript
import { payloadDrizzle } from '@payload-config';
import { sql } from 'drizzle-orm';

const result = await payloadDrizzle.execute(sql`SELECT * FROM appointments WHERE service = ${serviceId}`);
```

## UI & Design System

### Glassmorphic Components

The glass aesthetic now lives inside `@/components/ui/glass` as typed primitives:

- `GlassSurface` – hero/section shell with layered gradients
- `GlassPanel` – content-friendly panel with `variant`, `state`, and `density` props
- `GlassChip` – chip/badge primitive with tone + shape variants
- `GlassPill` – pill-shaped CTA shell (also exposed via `<Button variant="glass-pill">`)

Use the accompanying style helpers (`glassPanelStyles`, etc.) when you need the class string for native inputs.

Legacy gradient buttons are still available as global classes:

- `.btn-primary` - Accent gradient button with glow effects
- `.btn-secondary` - Glass variant button

### Font System

- **Primary font**: Peyda (Persian-optimized)
  - Files: `public/fonts/peyda-{regular,medium,bold}.woff2`
  - Loaded via `@font-face` in `styles/globals.css`
  - `font-display: swap` for performance
- RTL layout: Set via `html dir="rtl"` in root layout

### Theme System

- Uses `next-themes` with `ThemeProvider` wrapper
- CSS variables for dynamic theming: `--bg`, `--fg`, `--accent`, `--accent-strong`, etc.
- Light mode: `:root` selector
- Dark mode: `[data-theme='dark']` selector
- Toggle component: `ThemeToggle.tsx`

### Layout Components

- **Header** (`src/components/Header.tsx`): Sticky navigation bar with theme toggle
- **Sidebar** (`src/components/Sidebar.tsx`): Fixed right sidebar (GNOME-style) with glassmorphic styling
- **Main Layout** (`src/app/(site)/layout.tsx`): Combines Header + Sidebar + responsive content area

## Booking API

Custom REST endpoints for appointment management:

- `GET /api/availability` - Check slot availability
- `POST /api/hold` - Place 5-minute hold on a slot
- `POST /api/book` - Complete a booking

Uses Redis for hold management with configurable TTL.

### Redis Implementation Note

The current Redis client (`src/lib/redis.ts`) is an **in-memory stub** for development. It simulates Redis functionality using a JavaScript Map with automatic expiration cleanup. To integrate a real Redis instance:

1. Replace the stub implementation with a real Redis client (e.g., `ioredis`)
2. Update the `bookingHold` object methods to use Redis commands
3. Ensure `REDIS_URL` and `REDIS_TLS` environment variables are properly configured

## Collection Hooks & Access Control

### Appointments Collection

The Appointments collection (`src/collections/Appointments.ts`) implements several important patterns:

1. **Before Validate Hook** (`serviceSchedulingHook`):
   - Auto-generates unique reference codes (format: `APT-{timestamp}-{random}`)
   - Automatically calculates `schedule.end` from `schedule.start` + service duration
   - Snapshots service pricing at booking time to preserve historical rates
   - Auto-assigns provider if service has only one provider configured

2. **After Change Hook** (`releaseBookingHoldAfterCreate`):
   - Releases Redis holds after appointment creation
   - Prevents double-booking by clearing the temporary hold

3. **Access Control**:
   - Read/Update/Delete: Users can only see their own appointments (as client) OR appointments where they are the provider
   - Admins can see all appointments
   - Create: Any authenticated user

### Users Collection

Implements special first-user creation logic (`isFirstUserCreation` access control) that allows unauthenticated user creation when the database is empty, enabling initial setup.

## Important Notes

- Auto-generated Payload files (marked with "THIS FILE WAS GENERATED AUTOMATICALLY") should never be manually edited
- The project uses `import.meta.url` (ESM) - avoid CommonJS patterns
- Sharp is required for image processing and must be installed as a dependency
- Admin panel routing is handled by Payload's catch-all `[[...segments]]` route
- When adding UI components, reuse the primitives in `@/components/ui/glass` (`GlassSurface`, `GlassPanel`, etc.)
- Ensure RTL compatibility when working with text and layout—test with Persian content
- Tailwind config includes custom color tokens; use `accent`, `accent-strong`, etc. instead of arbitrary colors

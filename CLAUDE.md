# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Next.js 15 application integrated with PayloadCMS 3.x, using PostgreSQL as the database and Redis for caching. The project combines a headless CMS backend with a Next.js frontend, all in a monolithic architecture.

## Development Commands

```bash
# Start development server (default port 3000)
npm run dev

# Build production bundle
npm run build

# Start production server
npm run start

# Run ESLint
npm run lint
```

## Docker Environment

The project includes Docker Compose configuration with three services:
- `postgres`: PostgreSQL 16 database (port 5432)
- `redis`: Redis 7 cache (port 6379)
- `web`: Next.js application (port 3000)

Start services:
```bash
docker-compose up -d
```

## Architecture

### Route Group Structure

The application uses Next.js App Router with three distinct route groups:

1. **`(payload)` Route Group** - PayloadCMS Admin & API
   - Admin panel at `/admin` (auto-generated by Payload)
   - REST API at `/api/[...slug]`
   - GraphQL API at `/api/graphql` and `/api/graphql-playground`
   - Uses custom layout with Payload's RootLayout component
   - Files marked "GENERATED AUTOMATICALLY BY PAYLOAD" should not be manually modified

2. **`(frontend)` Route Group** - Main Application Frontend
   - Default landing page that integrates with Payload auth
   - Shows welcome message and links to admin panel
   - Located at `src/app/(frontend)/page.tsx`

3. **`(site)` Route Group** - Alternative Frontend
   - Contains a standard Next.js page with Tailwind styling
   - Uses Geist fonts
   - Located at `src/app/(site)/page.tsx`

### PayloadCMS Configuration

Main config: `src/payload.config.ts`

Key aspects:
- Database: PostgreSQL via `@payloadcms/db-postgres`
- Rich text editor: Lexical (`@payloadcms/richtext-lexical`)
- Image processing: Sharp
- Collections are defined in `src/collections/`
- TypeScript types auto-generated to `src/payload-types.ts`

### Collections

Defined in `src/collections/`:
- **Users**: Authentication collection with email as title field
- **Media**: File upload collection with public read access and required alt text

To add new collections:
1. Create collection config in `src/collections/`
2. Import and add to `collections` array in `src/payload.config.ts`
3. Types will regenerate automatically

### Environment Variables

Required in `.env`:
- `PAYLOAD_SECRET`: Secret key for Payload authentication
- `DATABASE_URI`: PostgreSQL connection string (format: `postgresql://user:pass@host:port/db`)

Docker defaults:
- DB: `postgresql://cyannobat:cyannopass@postgres:5432/cyannobat`

### TypeScript Configuration

Path aliases:
- `@/*` maps to `src/*`
- `@payload-config` maps to `src/payload.config.ts`

Target: ES2017 with strict mode enabled

### Next.js Configuration

The Next.js config (`next.config.ts`) wraps the base configuration with `withPayload()` from `@payloadcms/next/withPayload` - this is required for Payload integration.

## Key Integration Points

### Accessing Payload in Server Components

```typescript
import { getPayload } from 'payload'
import config from '@payload-config'

const payload = await getPayload({ config })
```

### Checking Authentication

```typescript
import { headers as getHeaders } from 'next/headers'
const headers = await getHeaders()
const { user } = await payload.auth({ headers })
```

## Important Notes

- Auto-generated Payload files (marked with "THIS FILE WAS GENERATED AUTOMATICALLY") should never be manually edited
- The project uses `import.meta.url` (ESM) - avoid CommonJS patterns
- Sharp is required for image processing and must be installed as a dependency
- Admin panel routing is handled by Payload's catch-all `[[...segments]]` route
